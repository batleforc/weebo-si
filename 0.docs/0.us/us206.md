# Mise en place d'une stack de Monitoring (Log/Trace/Métrique)

## Besoins

- Collecte des métriques MainCluster / SubCluster
- Collecte des logs MainCluster / SubCluster
- Collecte des traces MainCluster / SubCluster
- Alerting
  - Santé des clusters
  - Santé des applications
- Reporting
  - Bilan de santé a la semaine auto
- Réactivité
  - Si app commence a trop consommer et flag comme non critique, scale a 0 (ou juste MR sur GitOps ?)
- GitOps && Automatisable
  - Injection des configurations via GitOps ou solution Gitopsifiable
  - Automatisation des déploiements et des mises à jour
  - Gestion des secrets et des configurations sensibles (Toute les briques doivent communiquer de manière sécurisée)

## Possibilités Techniques

- Prometheus = Stockage Metric > A Challenger
- Tempo = Stockage Trace > A Challenger
- Loki = Stockage Log > A Challenger
- Grafana = Visualisation > A Challenger

## Source

- kubelet /metrics/resource
- <https://github.com/prometheus/node_exporter>

## Collection Pipeline

- [Vector](https://vector.dev/)
- [Alloy](https://grafana.com/docs/alloy/latest/)
- [Odigos](https://odigos.io/) => eBPF trace collector/creator
- [Fluentd](https://www.fluentd.org/) => Log collector

### Vector

- <https://www.talos.dev/v1.10/talos-guides/configuration/logging/#vector-example>

## Database

- [Gigapipe](https://github.com/metrico/gigapipe) => Basiquement Clickhouse mais en polyglot

### Metrics

- [Prometheus](https://prometheus.io/)
- [Clickhouse](https://clickhouse.com/)
- [VictoriaMetrics](https://victoriametrics.com/)
- [Gigapipe](https://github.com/metrico/gigapipe)
- [Thanos](https://thanos.io/)
- [Cortex](https://cortexmetrics.io/)
- [Mimir](https://grafana.com/oss/mimir/)

### Traces

- [Tempo](https://grafana.com/oss/tempo/)
- [Clickhouse](https://clickhouse.com/)
- [VictoriaTraces](https://docs.victoriametrics.com/victorialogs/)
- [Gigapipe](https://github.com/metrico/gigapipe)

### Logs

- [Loki](https://grafana.com/oss/loki/)
- [Clickhouse](https://clickhouse.com/)
- [VictoriaLogs](https://docs.victoriametrics.com/victorialogs/)
- [Gigapipe](https://github.com/metrico/gigapipe)

### Waiting

- <https://github.com/GreptimeTeam/greptimedb>

## Visualisation

- [Grafana](https://grafana.com/)
- [HyperDX](https://hyperdx.io/) -> Clickhouse only
- [Perses](https://github.com/perses/perses)
- [UpTrace](https://github.com/uptrace/uptrace)
- [Signoz](https://signoz.io/)

### Grafana

- <https://grafana.com/grafana/plugins/grafana-clickhouse-datasource/>

### Signoz

Signoz parait être assez cool. Si vous voulez plus d'info je vous invite a aller voir le stream de [TheRealSeboss666](https://www.twitch.tv/videos/2514289993).

#### CONTRE

- Zookeeper

#### Pour

Le produis semble vachement bien et super intelligent (Sauf que Zookeeper)

## Alerting

- [Alertmanager](https://prometheus.io/docs/alerting/latest/alertmanager/) -> Prometheus only

## Conclusion

### Status 30 Août 2025

```mermaid
flowchart TB
  subgraph Source
    subgraph Trace
      app-trace@{ icon: "logos:opentelemetry-icon", form: "square", label: "trace applicative", pos: "t" }
      traefik-trace@{ icon: "logos:opentelemetry-icon", form: "square", label: "trace traefik", pos: "t" }
    end
    subgraph Metric
      node-exporter@{ icon: "mdi:server", form: "square", label: "node-exporter", pos: "t" }
      kubelet@{ icon: "logos:kubernetes", form: "square", label: "kubelet-metrics", pos: "t" }
      kubernetes-metrics@{ icon: "logos:kubernetes", form: "square", label: "kubernetes-metrics", pos: "t" }
      talos-machine-exporter@{ icon: "mdi:server", form: "square", label: "talos-machine-exporter", pos: "t" }
    end
    subgraph Log
      kubernetes-log@{ icon: "logos:kubernetes", form: "square", label: "kubernetes-log", pos: "t" }
      kernel-logs@{ icon: "mdi:server", form: "square", label: "kernel-logs", pos: "t" }
      service-logs@{ icon: "mdi:server", form: "square", label: "service-logs", pos: "t" }
    end
  end
  subgraph Collection
    vector@{ icon: "logos:vector", form: "square", label: "vector", pos: "t" }
    alloy@{ icon: "logos:alloy", form: "square", label: "alloy", pos: "t" }
    odigos@{ icon: "logos:odigos", form: "square", label: "Odigos", pos: "t" }
    fluentd@{ icon: "logos:fluentd", form: "square", label: "Fluentd", pos: "t" }
  end
  subgraph Database
    prometheus@{ icon: "logos:prometheus", form: "square", label: "prometheus", pos: "t" }
    tempo@{ icon: "logos:opentelemetry-icon", form: "square", label: "Tempo", pos: "t" }
    loki@{ icon: "mdi:math-log", form: "square", label: "Loki", pos: "t" }
    clickhouse@{ icon: "mdi:cursor-default-click", form: "square", label: "Clickhouse", pos: "t" }
    gigapipe@{ icon: "mdi:cursor-default-click", form: "square", label: "Gigapipe", pos: "t" }
    thanos@{ icon: "logos:prometheus", form: "square", label: "Thanos (Prometheus HA)", pos: "t" }
    cortex@{ icon: "logos:prometheus", form: "square", label: "Cortex", pos: "t" }
    mimir@{ icon: "logos:prometheus", form: "square", label: "Mimir", pos: "t" }
    subgraph Victoria
      victoria-metrics@{ icon: "mdi:database", form: "square", label: "Victoria-Metrics", pos: "t" }
      victoria-traces@{ icon: "mdi:database", form: "square", label: "Victoria-Traces", pos: "t" }
      victoria-logs@{ icon: "mdi:database", form: "square", label: "Victoria-Logs", pos: "t" }
    end
  end
  subgraph Visualization
    grafana@{ icon: "logos:grafana", form: "square", label: "Grafana", pos: "t" }
    hyperdx@{ icon: "mdi:web", form: "square", label: "HyperDX", pos: "t" }
    perses@{ icon: "mdi:web", form: "square", label: "Perses", pos: "t" }
    uptrace@{ icon: "mdi:web", form: "square", label: "UpTrace", pos: "t" }
    signoz@{ icon: "mdi:web", form: "square", label: "Signoz", pos: "t" }
  end

  Collection --> Database

  hyperdx --> clickhouse
  uptrace --> clickhouse
  signoz --> clickhouse

  grafana --> clickhouse
  grafana --> tempo
  grafana --> loki
  grafana --> prometheus
  grafana --> Victoria
  grafana --> gigapipe
  grafana --> thanos
  grafana --> uptrace
  grafana --> mimir
  grafana --> cortex

  gigapipe <--> clickhouse

  perses --> prometheus
  perses --> loki
  perses --> tempo

  Trace ==> tempo
  Trace ==> victoria-traces
  Trace ==> clickhouse

  Trace ==> vector
  Trace ==> alloy
  Trace ==> odigos

  Log l1@--> loki
  Log l2@--> victoria-logs
  Log l3@--> clickhouse

  Log l4@--> vector
  Log l5@--> alloy
  Log l6@--> fluentd
  Log l7@--> odigos

  Metric -.-> prometheus
  Metric -.-> victoria-metrics
  Metric -.-> clickhouse
  Metric -.-> thanos
  Metric -.-> cortex
  Metric -.-> mimir

  Metric -.-> vector
  Metric -.-> alloy
  Metric -.-> odigos

  classDef animate stroke-dasharray: 9,5,stroke-dashoffset: 900,animation: dash 25s linear infinite;
  class l1 animate
  class l2 animate
  class l3 animate
  class l4 animate
  class l5 animate
  class l6 animate
  class l7 animate

```

Pas d'alerting dans le graph pour le moment, je n'ai pas encore de solutions qui me convienne
