apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: harbor-app
  namespace: argocd
spec:
  project: default
  syncPolicy:
    automated: {}
  source:
    chart: harbor
    repoURL: https://helm.goharbor.io
    targetRevision: "{{ .Values.version.helm }}"
    helm:
      releaseName: harbor-app
      valuesObject:
        portal:
          automountServiceAccountToken: true
        core:
          automountServiceAccountToken: true
          podAnnotations:
            inject-certs: "enabled"
            vault.security.banzaicloud.io/vault-addr: "https://vault.vault:8200"
            vault.security.banzaicloud.io/vault-role: "auth-read"
            vault.security.banzaicloud.io/vault-path: "kubernetes"
            vault.security.banzaicloud.io/vault-tls-secret: "vault-tls"
        expose:
          tls:
            certSource: secret
            secret:
              secretName: harbor-tls
          ingress:
            hosts:
              core: "core.harbor.4.weebo.fr"
            annotations:
              cert-manager.io/cluster-issuer: "outbound"
              ingress.kubernetes.io/ssl-redirect: "true"
              ingress.kubernetes.io/proxy-body-size: "0"
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
              nginx.ingress.kubernetes.io/proxy-body-size: "0"
        externalURL: "https://core.harbor.4.weebo.fr"
        persistence:
          persistentVolumeClaim:
            registry:
              size: 20Gi
        harborAdminPassword: "vault:mc-authentik/data/harbor/config#HARBOR_ADMIN_PASSWORD"
        internalTLS:
          enabled: true
        secretKey: {{ randAlphaNum 16 | quote }}
        metrics:
          enabled: true


  destination:
    server: "https://kubernetes.default.svc"
    namespace: harbor
