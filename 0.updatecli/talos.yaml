name: Upgrade Talos

scms:
  default:
    kind: github
    spec:
      user: "{{ .github.user }}"
      email: "{{ .github.email }}"
      owner: batleforc
      repository: weebo-si
      token: "{{ requiredEnv .github.token }}"
      username: "{{ .github.username }}"
      branch: main

actions:
  talos:
    kind: github/pullrequest
    scmid: default
    spec:
      title: 'ci: Bump Talos Provider'
      automerge: false
      description: |
        Bump Qemu Guest Agent
        - `qemuGuestAgent` version: {{ source "qemuGuestAgent" }}

sources:
  qemuGuestAgent:
    kind: dockerimage
    spec:
      image: ghcr.io/siderolabs/qemu-guest-agent
      architecture: "linux/amd64"
      versionFilter:
        kind: semver

targets:
  bumpQemuGuestAgent:
    name: "Update QEMU Guest Agent"
    kind: yaml
    scmid: default
    spec:
      file: capi.argo/helm/cluster/values.yaml
      key: "extensions.qemuGuestAgent.image"
      value: 'ghcr.io/siderolabs/qemu-guest-agent:{{ source "qemuGuestAgent" }}'
